name: Test Build

on:
  push:
    branches:
      - master
      - main
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - 'LICENSE'
      - 'docs/**'
  workflow_dispatch:
    inputs:
      build_all_platforms:
        description: 'Build for all platforms (otherwise only current platform)'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  discussions: write

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  # å¿«é€Ÿæ„å»ºä½œä¸šï¼šåªæ„å»ºå½“å‰å¹³å°ï¼Œç”¨äºå¿«é€ŸéªŒè¯
  quick-build:
    if: github.event_name == 'push'
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            arch: x64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'yarn'

      - name: Install system dependencies (Linux)
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libnss3-dev \
            libatk-bridge2.0-dev \
            libdrm-dev \
            libxcomposite-dev \
            libxdamage-dev \
            libxrandr-dev \
            libgbm-dev \
            libxss-dev \
            libasound2-dev \
            libatspi2.0-dev \
            libgtk-3-dev

      - name: Install main dependencies
        run: yarn install --frozen-lockfile

      - name: Install renderer dependencies
        run: |
          cd renderer
          yarn install --frozen-lockfile

      - name: Quick build test
        run: yarn make --arch=${{ matrix.arch }}

      - name: Upload quick build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: quick-build-${{ github.sha }}
          path: |
            out/make/**/*.deb
            out/make/**/*.rpm
          retention-days: 3

  # å®Œæ•´æ„å»ºä½œä¸šï¼šæ„å»ºæ‰€æœ‰å¹³å°ï¼Œæ‰‹åŠ¨è§¦å‘æˆ–ç‰¹å®šæ¡ä»¶
  full-build:
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.build_all_platforms == 'true'
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        include:
          # Windows builds
          - os: windows-latest
            arch: x64
            platform: win32

          # macOS builds
          - os: macos-latest
            arch: x64
            platform: darwin
          - os: macos-latest
            arch: arm64
            platform: darwin

          # Linux builds
          - os: ubuntu-latest
            arch: x64
            platform: linux

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'yarn'

      - name: Setup Python (for native dependencies)
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install system dependencies (Linux)
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libnss3-dev \
            libatk-bridge2.0-dev \
            libdrm-dev \
            libxcomposite-dev \
            libxdamage-dev \
            libxrandr-dev \
            libgbm-dev \
            libxss-dev \
            libasound2-dev \
            libatspi2.0-dev \
            libgtk-3-dev

      - name: Install main dependencies
        run: yarn install --frozen-lockfile

      - name: Install renderer dependencies
        run: |
          cd renderer
          yarn install --frozen-lockfile

      - name: Build and package for ${{ matrix.platform }}-${{ matrix.arch }}
        run: yarn make --arch=${{ matrix.arch }}
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_ID_PASS: ${{ secrets.APPLE_ID_PASS }}
          CSC_LINK: ${{ secrets.CSC_LINK }}
          CSC_KEY_PASSWORD: ${{ secrets.CSC_KEY_PASSWORD }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: test-build-${{ matrix.platform }}-${{ matrix.arch }}-${{ github.sha }}
          path: |
            out/make/**/*.exe
            out/make/**/*.dmg
            out/make/**/*.zip
            out/make/**/*.deb
            out/make/**/*.rpm
            out/make/**/*.AppImage
          retention-days: 7

  # åˆ›å»ºæµ‹è¯•ç‰ˆæœ¬å‘å¸ƒ
  create-test-release:
    needs: full-build
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.build_all_platforms == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release files
        run: |
          mkdir -p release-files

          # Copy all built files to release directory
          find artifacts -type f \( -name "*.exe" -o -name "*.dmg" -o -name "*.zip" -o -name "*.deb" -o -name "*.rpm" -o -name "*.AppImage" \) -exec cp {} release-files/ \;

          # List files to be released
          echo "Files to be released:"
          ls -la release-files/

      - name: Get current date and commit info
        id: get_info
        run: |
          echo "date=$(date +'%Y%m%d-%H%M')" >> $GITHUB_OUTPUT
          echo "commit_short=${GITHUB_SHA:0:7}" >> $GITHUB_OUTPUT
          echo "commit_message=$(git log -1 --pretty=%B)" >> $GITHUB_OUTPUT

      - name: Delete old test releases
        run: |
          # åˆ é™¤è¶…è¿‡ 5 ä¸ªçš„æµ‹è¯•ç‰ˆæœ¬å‘å¸ƒï¼Œä¿æŒä»“åº“æ•´æ´
          gh release list --limit 50 | grep "test-" | tail -n +6 | awk '{print $1}' | xargs -r -I {} gh release delete {} --yes
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: Create Test Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: test-${{ steps.get_info.outputs.date }}-${{ steps.get_info.outputs.commit_short }}
          name: ğŸ§ª æµ‹è¯•ç‰ˆæœ¬ ${{ steps.get_info.outputs.date }}-${{ steps.get_info.outputs.commit_short }}
          body: |
            ## ğŸ§ª æµ‹è¯•ç‰ˆæœ¬æ„å»º

            **âš ï¸ è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•ç‰ˆæœ¬ï¼Œä»…ç”¨äºå¼€å‘å’Œæµ‹è¯•ç›®çš„ï¼Œä¸æ¨èåœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ã€‚**

            ### ğŸ“‹ æ„å»ºä¿¡æ¯
            - **æ„å»ºæ—¶é—´**: ${{ steps.get_info.outputs.date }}
            - **æäº¤å“ˆå¸Œ**: `${{ steps.get_info.outputs.commit_short }}`
            - **åˆ†æ”¯**: `${{ github.ref_name }}`
            - **æœ€æ–°æäº¤**: ${{ steps.get_info.outputs.commit_message }}

            ### ğŸ“¦ æµ‹è¯•å®‰è£…åŒ…

            **Windows:**
            - `memos-*-setup.exe` - Windows å®‰è£…ç¨‹åº

            **macOS:**
            - `memos-*.dmg` - macOS ç£ç›˜æ˜ åƒ
            - `memos-darwin-*.zip` - macOS åº”ç”¨ç¨‹åºåŒ…

            **Linux:**
            - `memos-*.deb` - Debian/Ubuntu è½¯ä»¶åŒ…
            - `memos-*.rpm` - RedHat/Fedora è½¯ä»¶åŒ…

            ### ğŸ” æµ‹è¯•è¯´æ˜

            1. **å¤‡ä»½æ•°æ®**: ä½¿ç”¨å‰è¯·å¤‡ä»½é‡è¦æ•°æ®
            2. **å·²çŸ¥é—®é¢˜**: å¯èƒ½åŒ…å«æœªä¿®å¤çš„ bug
            3. **åé¦ˆæ¸ é“**: å‘ç°é—®é¢˜è¯·åˆ›å»º Issue

            ### ğŸ“ å®‰è£…æ–¹å¼

            ä¸æ­£å¼ç‰ˆæœ¬å®‰è£…æ–¹å¼ç›¸åŒï¼Œä½†å»ºè®®å®‰è£…åœ¨ç‹¬ç«‹ç›®å½•è¿›è¡Œæµ‹è¯•ã€‚

            ---

            ğŸ”— **ç›¸å…³é“¾æ¥**:
            - [å®Œæ•´æäº¤å†å²](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
            - [æºä»£ç ](https://github.com/${{ github.repository }}/tree/${{ github.sha }})
          files: release-files/*
          draft: false
          prerelease: true
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Notify build completion
        run: |
          echo "âœ… æµ‹è¯•ç‰ˆæœ¬æ„å»ºå®Œæˆ!"
          echo "ğŸ“¦ ç‰ˆæœ¬å·: test-${{ steps.get_info.outputs.date }}-${{ steps.get_info.outputs.commit_short }}"
          echo "ğŸ”— å‘å¸ƒåœ°å€: ${{ steps.create_release.outputs.url }}"

  # æ„å»ºçŠ¶æ€é€šçŸ¥
  notify-status:
    needs: [quick-build]
    if: always() && github.event_name == 'push'
    runs-on: ubuntu-latest

    steps:
      - name: Check build status
        run: |
          if [ "${{ needs.quick-build.result }}" == "success" ]; then
            echo "âœ… å¿«é€Ÿæ„å»ºæˆåŠŸ"
            echo "ğŸ“ æäº¤: ${{ github.sha }}"
            echo "ğŸ‘¤ æäº¤è€…: ${{ github.actor }}"
            echo "ğŸ’¡ æç¤º: å¦‚éœ€å®Œæ•´çš„å¤šå¹³å°æ„å»ºï¼Œè¯·æ‰‹åŠ¨è§¦å‘ workflow"
          else
            echo "âŒ å¿«é€Ÿæ„å»ºå¤±è´¥"
            echo "ğŸ“ æäº¤: ${{ github.sha }}"
            echo "ğŸ‘¤ æäº¤è€…: ${{ github.actor }}"
            echo "ğŸ” è¯·æ£€æŸ¥æ„å»ºæ—¥å¿—ä»¥äº†è§£å¤±è´¥åŸå› "
          fi
